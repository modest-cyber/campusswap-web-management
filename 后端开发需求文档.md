# 西安石油大学校园二手商品交易网后端开发需求文档（不含数据库）

> 基于《需求分析.md》，聚焦后端业务与接口实现，排除数据库建模细节。采用 Spring Boot 3 + MyBatis + MySQL（数据库已独立完成），前后端分离，接口遵循 RESTful + JWT 鉴权。

## 1. 总体目标
- 提供用户、商品、订单、收藏、评价、统计、后台管理等服务接口。
- 落实鉴权与权限控制，保证普通用户与管理员的权限边界。
- 完成日志、异常、统一响应、文件上传等基础能力。

## 2. 技术约束
- Spring Boot 3，JDK 21。
- MyBatis（注解或 XML 映射），分页建议使用 PageHelper/自研分页。
- JSON 序列化使用 Jackson，时间统一 ISO 8601（UTC+8）。
- 身份认证：JWT（Header: Authorization: Bearer <token>）。
- 文件存储：本地存储占位方案（后续可替换为对象存储）。
- 统一返回格式：`{ code, message, data, traceId }`，code 0 表示成功。

## 3. 环境与配置（不含数据库）
- `server.port=8080`
- `server.servlet.context-path=/`
- 日志：根级别 INFO，业务包 DEBUG（可配置）。
- 文件上传：单文件 ≤5MB，请求 ≤10MB（已在 application.properties 配置）。
- 跨域：开启基础 CORS（允许前端域名，支持凭证、允许常用方法）。

## 4. 接口与业务需求

### 4.1 鉴权/认证模块
- 登录：`POST /api/user/login`，入参用户名/邮箱/手机号 + 密码；返回 JWT + 用户概要。
- 注册：`POST /api/user/register`，入参校验密码强度与唯一性；返回成功状态。
- 登出：前端删除 token；后端预留黑名单/失效机制接口（可选）。
- 刷新 token（可选）：`POST /api/user/refresh-token`，用于长会话。
- 中间件：拦截器/Filter 校验 JWT，解析用户ID、角色，注入上下文；跳过登录/注册/静态资源。

### 4.2 用户中心
- 获取个人信息：`GET /api/user/info`。
- 更新个人信息：`PUT /api/user/info`（不可修改用户名）。
- 修改密码：`PUT /api/user/password`（原密码校验）。
- 上传头像：`POST /api/user/avatar`，返回可访问 URL。
- 注销账号：`DELETE /api/user`，需检查未完成订单。

### 4.3 商品模块
- 发布商品：`POST /api/product`，校验必填项、图片列表、价格>0；默认状态待审核/在售（根据配置）。
- 更新商品：`PUT /api/product/{id}`，仅商品所有者可改且未售出。
- 下架/上架：`PUT /api/product/{id}/status`，卖家可下架/重新上架。
- 删除商品：`DELETE /api/product/{id}`，未成交方可删。
- 商品列表：`GET /api/product/list`，分页 + 过滤（分类/价格区间/状态/关键词）+ 排序（时间/价格/热度）。
- 商品详情：`GET /api/product/{id}`，增加浏览量。
- 收藏/取消收藏：`POST /api/product/{id}/favorite`，`DELETE .../favorite`。
- 我的商品：`GET /api/product/my`，分页。
- 收藏列表：`GET /api/product/favorite`，分页。
- 举报商品（预留）：`POST /api/product/{id}/report`（可先记录到日志或表中，后台手动处理）。

### 4.4 订单与交易模块
- 创建订单：`POST /api/order`，校验商品状态、库存（默认1）、买卖双方不可同人；生成唯一 order_no。
- 订单列表：`GET /api/order/list`，支持买家/卖家视角过滤、状态过滤、时间区间。
- 订单详情：`GET /api/order/{id}`，仅相关双方或管理员可见。
- 更新状态：
  - 卖家发货（邮寄）/确认面交：`PUT /api/order/{id}/deliver`
  - 买家确认收货：`PUT /api/order/{id}/confirm`
  - 取消订单：`DELETE /api/order/{id}`，规则：待支付可单方取消，发货后需协商或管理员介入。
- 订单备注：创建时可写 remark。
- 地址：仅邮寄时必填。

### 4.5 评价模块（可选但推荐）
- 对已完成订单评价：`POST /api/review`，入参 orderId、rating(1-5)、comment。
- 查询评价：`GET /api/review/by-user`（作为被评价人）、`GET /api/review/by-order/{id}`。
- 约束：每个订单双方各一次评价，重复提交需阻止或覆盖策略。

### 4.6 管理员后台
- 用户管理：列表、详情、禁用/启用、重置密码：`PUT /api/admin/user/{id}/status`。
- 商品审核：`PUT /api/admin/product/{id}/audit`（通过/拒绝，拒绝理由）。
- 商品下架/删除：违规处理。
- 订单查看：`GET /api/admin/order/list`，支持状态/时间过滤。
- 公告管理（预留）：`POST/PUT/DELETE /api/admin/announcement`。

### 4.7 统计与报表（管理员）
- 用户统计：注册趋势、活跃度（基于登录或下单）、院系分布。
- 商品统计：分类分布、发布趋势、热门商品（浏览/收藏/成交）。
- 交易统计：订单量、成交额、成功率、面交/邮寄占比、排行（买家/卖家）。
- 综合概览：聚合今日/本周/本月关键指标接口。

### 4.8 文件上传
- 端点：`POST /api/file/upload`（用于商品图片/头像）；限制类型、大小；返回可访问 URL。
- 存储：本地目录（配置化 root），URL 通过静态资源映射暴露。

### 4.9 通用与基础设施
- 全局异常处理：捕获校验异常、业务异常、系统异常，返回统一结构。
- 参数校验：JSR 380（Hibernate Validator），入参 DTO 分组校验。
- 统一分页响应：`{ list, pageNum, pageSize, total }`。
- Idempotent 设计：关键接口（下单）可使用雪花ID/前端幂等键（可选）。
- TraceId：使用 MDC 注入，日志输出 traceId。

## 5. 安全与权限
- JWT 鉴权 + 角色校验（普通用户/管理员）。
- 资源授权：仅资源所有者可改/删自己的商品、订单；管理员全局。
- 防刷：登录失败次数限制，关键接口（登录/注册/下单）加入简易频控（可用令牌桶/滑动窗口，或网关限流）。
- 输入安全：防 SQL 注入（MyBatis 参数绑定）、防 XSS（输出转义/前端渲染时处理）。
- 隐私：手机号/邮箱对非相关用户脱敏展示。

## 6. 日志与监控
- 访问日志：记录方法、路径、耗时、用户ID/角色、状态码。
- 业务日志：订单状态变更、审核操作、登录失败。
- 错误日志：统一错误码/信息，便于前端提示与排查。

## 7. 测试要求（后端）
- 单元测试：Service/Util 层核心逻辑。
- 集成测试：接口级（MockMvc 或 RestAssured），覆盖登录、下单、审核、权限校验。
- 回归用例：下单流程、商品上下架、审核拒绝、权限边界。

## 8. 开发日程拆分（建议 5 天）
- **Day 1：基础骨架与鉴权**
  - 项目基础配置（全局异常、统一响应、基础拦截器、日志 Mdc、CORS）。
  - 用户注册/登录/刷新 token、获取个人信息、修改密码。
  - JWT 中间件与上下文注入；密码加密（BCrypt）。
- **Day 2：用户中心与文件上传**
  - 个人信息更新、头像上传（本地存储）、注销账号逻辑。
  - 文件上传接口与静态资源映射、类型/大小校验。
- **Day 3：商品与收藏**
  - 商品发布/更新/上下架/删除、详情、列表（筛选/排序）、我的商品。
  - 收藏/取消收藏、收藏列表；浏览量计数。
  - 简易举报接口（记录日志或表，后台预留处理）。
- **Day 4：订单与评价**
  - 下单、订单列表（买家/卖家视角）、详情、发货/确认收货/取消。
  - 订单状态机校验、幂等处理（基础版）。
  - 评价提交/查询（可选开关）。
- **Day 5：后台与统计**
  - 管理员：用户禁用/启用，商品审核/下架，订单查看。
  - 统计接口：用户/商品/交易基础指标与趋势，概览接口。
  - 完成主要集成测试与回归用例。

## 9. 交付验收标准
- 接口按文档完成，提供 Swagger/OpenAPI 说明。
- 角色权限正确：普通用户不可操作他人资源；管理员具备审核/管理能力。
- 基础安全措施可用：JWT 鉴权、参数校验、错误码一致、上传限制。
- 关键链路测试通过：注册→登录→发布商品→下单→发货→确认收货→评价；管理员审核流。


