# 数据库设计文档

## 1. 数据库概述

- **数据库名称**：`campusswap`
- **字符集**：`utf8mb4`
- **排序规则**：`utf8mb4_unicode_ci`
- **存储引擎**：`InnoDB`

## 2. 数据表设计

### 2.1 用户表（user）

**表说明**：存储系统用户信息，包括普通用户和管理员。

| 字段名 | 类型 | 长度 | 是否为空 | 主键 | 唯一 | 默认值 | 说明 |
|--------|------|------|----------|------|------|--------|------|
| id | BIGINT | - | NO | YES | - | AUTO_INCREMENT | 主键ID |
| username | VARCHAR | 50 | NO | - | YES | - | 用户名 |
| password | VARCHAR | 255 | NO | - | - | - | 密码（加密） |
| real_name | VARCHAR | 50 | YES | - | - | NULL | 真实姓名 |
| student_id | VARCHAR | 20 | YES | - | - | NULL | 学号/工号 |
| phone | VARCHAR | 20 | YES | - | YES | NULL | 手机号 |
| email | VARCHAR | 100 | YES | - | YES | NULL | 邮箱 |
| department | VARCHAR | 100 | YES | - | - | NULL | 所属院系 |
| avatar | VARCHAR | 255 | YES | - | - | NULL | 头像URL |
| role | TINYINT | - | NO | - | - | 0 | 角色（0-普通用户，1-管理员） |
| status | TINYINT | - | NO | - | - | 0 | 状态（0-正常，1-禁用） |
| create_time | DATETIME | - | NO | - | - | CURRENT_TIMESTAMP | 创建时间 |
| update_time | DATETIME | - | NO | - | - | CURRENT_TIMESTAMP | 更新时间 |

**索引**：
- PRIMARY KEY (`id`)
- UNIQUE KEY `uk_username` (`username`)
- UNIQUE KEY `uk_phone` (`phone`)
- UNIQUE KEY `uk_email` (`email`)
- KEY `idx_status` (`status`)
- KEY `idx_role` (`role`)

### 2.2 商品分类表（category）

**表说明**：存储商品分类信息，支持二级分类。

| 字段名 | 类型 | 长度 | 是否为空 | 主键 | 唯一 | 默认值 | 说明 |
|--------|------|------|----------|------|------|--------|------|
| id | BIGINT | - | NO | YES | - | AUTO_INCREMENT | 主键ID |
| name | VARCHAR | 50 | NO | - | - | - | 分类名称 |
| parent_id | BIGINT | - | YES | - | - | 0 | 父分类ID（0表示一级分类） |
| sort_order | INT | - | YES | - | - | 0 | 排序 |
| status | TINYINT | - | NO | - | - | 1 | 状态（0-禁用，1-启用） |
| create_time | DATETIME | - | NO | - | - | CURRENT_TIMESTAMP | 创建时间 |

**索引**：
- PRIMARY KEY (`id`)
- KEY `idx_parent_id` (`parent_id`)
- KEY `idx_status` (`status`)

### 2.3 商品表（product）

**表说明**：存储二手商品信息。

| 字段名 | 类型 | 长度 | 是否为空 | 主键 | 唯一 | 默认值 | 说明 |
|--------|------|------|----------|------|------|--------|------|
| id | BIGINT | - | NO | YES | - | AUTO_INCREMENT | 主键ID |
| user_id | BIGINT | - | NO | - | - | - | 发布者ID |
| category_id | BIGINT | - | NO | - | - | - | 分类ID |
| title | VARCHAR | 200 | NO | - | - | - | 商品名称 |
| description | TEXT | - | YES | - | - | NULL | 商品描述 |
| price | DECIMAL | 10,2 | NO | - | - | - | 价格 |
| original_price | DECIMAL | 10,2 | YES | - | - | NULL | 原价 |
| images | JSON | - | YES | - | - | NULL | 商品图片（JSON数组） |
| status | TINYINT | - | NO | - | - | 0 | 商品状态（0-待审核，1-在售，2-已下架，3-已售出，4-审核拒绝） |
| condition | VARCHAR | 20 | YES | - | - | NULL | 商品成色 |
| transaction_type | TINYINT | - | NO | - | - | 0 | 交易方式（0-面交，1-邮寄，2-均可） |
| view_count | INT | - | NO | - | - | 0 | 浏览量 |
| favorite_count | INT | - | NO | - | - | 0 | 收藏量 |
| create_time | DATETIME | - | NO | - | - | CURRENT_TIMESTAMP | 创建时间 |
| update_time | DATETIME | - | NO | - | - | CURRENT_TIMESTAMP | 更新时间 |

**外键约束**：
- `fk_product_user` FOREIGN KEY (`user_id`) REFERENCES `user` (`id`) ON DELETE CASCADE
- `fk_product_category` FOREIGN KEY (`category_id`) REFERENCES `category` (`id`)

**索引**：
- PRIMARY KEY (`id`)
- KEY `idx_user_id` (`user_id`)
- KEY `idx_category_id` (`category_id`)
- KEY `idx_status` (`status`)
- KEY `idx_create_time` (`create_time`)
- KEY `idx_price` (`price`)

### 2.4 订单表（order）

**表说明**：存储交易订单信息。

| 字段名 | 类型 | 长度 | 是否为空 | 主键 | 唯一 | 默认值 | 说明 |
|--------|------|------|----------|------|------|--------|------|
| id | BIGINT | - | NO | YES | - | AUTO_INCREMENT | 主键ID |
| order_no | VARCHAR | 50 | NO | - | YES | - | 订单号（唯一） |
| buyer_id | BIGINT | - | NO | - | - | - | 买家ID |
| seller_id | BIGINT | - | NO | - | - | - | 卖家ID |
| product_id | BIGINT | - | NO | - | - | - | 商品ID |
| quantity | INT | - | NO | - | - | 1 | 购买数量 |
| total_price | DECIMAL | 10,2 | NO | - | - | - | 总价 |
| transaction_type | TINYINT | - | NO | - | - | 0 | 交易方式 |
| status | TINYINT | - | NO | - | - | 0 | 订单状态（0-待支付，1-待发货，2-待收货，3-已完成，4-已取消） |
| remark | VARCHAR | 500 | YES | - | - | NULL | 备注 |
| address | VARCHAR | 500 | YES | - | - | NULL | 收货地址（邮寄时） |
| create_time | DATETIME | - | NO | - | - | CURRENT_TIMESTAMP | 创建时间 |
| update_time | DATETIME | - | NO | - | - | CURRENT_TIMESTAMP | 更新时间 |
| complete_time | DATETIME | - | YES | - | - | NULL | 完成时间 |

**外键约束**：
- `fk_order_buyer` FOREIGN KEY (`buyer_id`) REFERENCES `user` (`id`)
- `fk_order_seller` FOREIGN KEY (`seller_id`) REFERENCES `user` (`id`)
- `fk_order_product` FOREIGN KEY (`product_id`) REFERENCES `product` (`id`)

**索引**：
- PRIMARY KEY (`id`)
- UNIQUE KEY `uk_order_no` (`order_no`)
- KEY `idx_buyer_id` (`buyer_id`)
- KEY `idx_seller_id` (`seller_id`)
- KEY `idx_product_id` (`product_id`)
- KEY `idx_status` (`status`)
- KEY `idx_create_time` (`create_time`)

### 2.5 收藏表（favorite）

**表说明**：存储用户收藏的商品信息。

| 字段名 | 类型 | 长度 | 是否为空 | 主键 | 唯一 | 默认值 | 说明 |
|--------|------|------|----------|------|------|--------|------|
| id | BIGINT | - | NO | YES | - | AUTO_INCREMENT | 主键ID |
| user_id | BIGINT | - | NO | - | - | - | 用户ID |
| product_id | BIGINT | - | NO | - | - | - | 商品ID |
| create_time | DATETIME | - | NO | - | - | CURRENT_TIMESTAMP | 创建时间 |

**外键约束**：
- `fk_favorite_user` FOREIGN KEY (`user_id`) REFERENCES `user` (`id`) ON DELETE CASCADE
- `fk_favorite_product` FOREIGN KEY (`product_id`) REFERENCES `product` (`id`) ON DELETE CASCADE

**索引**：
- PRIMARY KEY (`id`)
- UNIQUE KEY `uk_user_product` (`user_id`, `product_id`)
- KEY `idx_user_id` (`user_id`)
- KEY `idx_product_id` (`product_id`)

### 2.6 评价表（review）

**表说明**：存储交易评价信息。

| 字段名 | 类型 | 长度 | 是否为空 | 主键 | 唯一 | 默认值 | 说明 |
|--------|------|------|----------|------|------|--------|------|
| id | BIGINT | - | NO | YES | - | AUTO_INCREMENT | 主键ID |
| order_id | BIGINT | - | NO | - | - | - | 订单ID |
| reviewer_id | BIGINT | - | NO | - | - | - | 评价者ID |
| reviewed_id | BIGINT | - | NO | - | - | - | 被评价者ID |
| rating | TINYINT | - | NO | - | - | - | 评分（1-5星） |
| comment | VARCHAR | 500 | YES | - | - | NULL | 评价内容 |
| create_time | DATETIME | - | NO | - | - | CURRENT_TIMESTAMP | 创建时间 |

**外键约束**：
- `fk_review_order` FOREIGN KEY (`order_id`) REFERENCES `order` (`id`)
- `fk_review_reviewer` FOREIGN KEY (`reviewer_id`) REFERENCES `user` (`id`)
- `fk_review_reviewed` FOREIGN KEY (`reviewed_id`) REFERENCES `user` (`id`)

**索引**：
- PRIMARY KEY (`id`)
- KEY `idx_order_id` (`order_id`)
- KEY `idx_reviewer_id` (`reviewer_id`)
- KEY `idx_reviewed_id` (`reviewed_id`)

## 3. 数据字典

### 3.1 用户角色（user.role）
- `0` - 普通用户
- `1` - 管理员

### 3.2 用户状态（user.status）
- `0` - 正常
- `1` - 禁用

### 3.3 商品状态（product.status）
- `0` - 待审核
- `1` - 在售
- `2` - 已下架
- `3` - 已售出
- `4` - 审核拒绝

### 3.4 交易方式（product.transaction_type / order.transaction_type）
- `0` - 面交
- `1` - 邮寄
- `2` - 均可

### 3.5 订单状态（order.status）
- `0` - 待支付
- `1` - 待发货
- `2` - 待收货
- `3` - 已完成
- `4` - 已取消

### 3.6 分类状态（category.status）
- `0` - 禁用
- `1` - 启用

## 4. 表关系图

```
user (用户表)
  ├── product (商品表) [user_id]
  ├── order (订单表) [buyer_id, seller_id]
  ├── favorite (收藏表) [user_id]
  └── review (评价表) [reviewer_id, reviewed_id]

category (分类表)
  └── product (商品表) [category_id]

product (商品表)
  ├── order (订单表) [product_id]
  └── favorite (收藏表) [product_id]

order (订单表)
  └── review (评价表) [order_id]
```

## 5. 索引设计说明

### 5.1 唯一索引
- `user.username` - 用户名唯一
- `user.phone` - 手机号唯一
- `user.email` - 邮箱唯一
- `order.order_no` - 订单号唯一
- `favorite(user_id, product_id)` - 用户商品收藏唯一

### 5.2 普通索引
- 外键字段建立索引，提升关联查询性能
- 常用查询字段建立索引（status、create_time等）
- 价格字段建立索引，支持价格排序查询

## 6. 初始数据

### 6.1 商品分类数据
系统预置了以下分类：
- 电子产品（手机、电脑、平板、耳机音响、其他电子）
- 图书教材（教材、参考书、小说文学、工具书、其他书籍）
- 生活用品（日用品、化妆品、小家电、收纳用品、其他生活用品）
- 服装配饰（男装、女装、鞋帽、配饰、其他服装）
- 运动用品（球类、健身器材、运动鞋、运动服、其他运动用品）
- 其他

### 6.2 默认管理员账号
- 用户名：`admin`
- 密码：`admin123`（已BCrypt加密）
- **注意**：首次登录后请立即修改密码！

## 7. 数据库维护

### 7.1 备份
```bash
mysqldump -u root -p campusswap > campusswap_backup_$(date +%Y%m%d).sql
```

### 7.2 恢复
```bash
mysql -u root -p campusswap < campusswap_backup_20240101.sql
```

### 7.3 性能优化建议
1. 定期分析表：`ANALYZE TABLE table_name;`
2. 定期优化表：`OPTIMIZE TABLE table_name;`
3. 监控慢查询日志
4. 根据实际查询情况调整索引

## 8. 注意事项

1. **字符集**：使用 `utf8mb4` 字符集，支持emoji和特殊字符
2. **外键约束**：表之间设置了外键约束，删除数据时请注意级联关系
3. **JSON字段**：`product.images` 字段使用JSON类型存储图片数组
4. **时间字段**：使用 `DATETIME` 类型，支持自动更新
5. **密码存储**：用户密码使用BCrypt加密存储，不可明文存储

